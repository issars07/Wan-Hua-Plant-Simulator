<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProSim Enterprise - Noodle Factory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; overflow-x: hidden; }

        .machine-node { 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .processing {
            background-color: #f0fdf4 !important;
            border-color: #22c55e !important;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
        }

        .unit {
            position: absolute;
            transition: all 0.5s ease-in-out;
            opacity: 0;
            z-index: 10;
        }
        .unit-entering { transform: translateX(-40px); opacity: 0; }
        .unit-processing { transform: translateX(0); opacity: 1; animation: pulse-work 1s infinite ease-in-out; }
        .unit-exiting { transform: translateX(40px); opacity: 0; }

        @keyframes pulse-work {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Truck Logistics - Facing Right */
        @keyframes inboundMove {
            0% { transform: translateX(-250px) scaleX(-1); opacity: 0; }
            10% { opacity: 1; }
            45% { transform: translateX(0) scaleX(-1); }
            90% { transform: translateX(0) scaleX(-1); opacity: 1; }
            100% { transform: translateX(0) scaleX(-1); opacity: 0; }
        }

        @keyframes outboundMove {
            0% { transform: translateX(0) scaleX(-1); opacity: 0; }
            10% { opacity: 1; }
            40% { transform: translateX(0) scaleX(-1); }
            100% { transform: translateX(250px) scaleX(-1); opacity: 0; }
        }

        .anim-inbound { animation: inboundMove var(--in-dur, 10s) ease-in-out infinite; }
        .anim-outbound { animation: outboundMove var(--out-dur, 10s) ease-in-out infinite; }

        .bottleneck-glow {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
            border: 2px solid #ef4444 !important;
        }

        .buffer-pill {
            width: 4px;
            height: 8px;
            background: #94a3b8;
            border-radius: 1px;
            margin: 1px;
        }

        .noodle-strand {
            width: 24px;
            height: 18px;
            background: repeating-linear-gradient(90deg, #fde047, #fde047 2px, transparent 2px, transparent 4px);
            border-radius: 2px;
        }

        input[type="number"] {
            border: 1px solid #cbd5e1;
            padding: 2px 6px;
            border-radius: 4px;
            width: 65px;
            font-size: 12px;
            font-weight: 700;
        }

        .toggle-btn {
            transition: all 0.2s;
        }
        .toggle-on { background-color: #10b981; color: white; }
        .toggle-off { background-color: #64748b; color: white; }

        .speed-btn.active {
            background-color: #f59e0b;
            color: white;
            border-color: #f59e0b;
        }
    </style>
</head>
<body class="p-4 md:p-6 pb-24">
    <div class="max-w-[1400px] mx-auto space-y-6">
        
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-2xl font-extrabold text-slate-900">ProSim <span class="text-amber-500">NoodleWorks</span></h1>
                <p class="text-xs text-slate-500 font-medium tracking-wide">Industrial Logistics Simulator</p>
            </div>

            <!-- Clock and Speed Control -->
            <div class="flex items-center gap-6">
                <div class="bg-slate-100 px-4 py-2 rounded-lg border border-slate-200 text-center min-w-[120px]">
                    <p class="text-[9px] font-bold text-slate-400 uppercase leading-none mb-1">Sim Time</p>
                    <div id="sim-clock" class="font-mono text-lg font-bold text-slate-700">00:00:00</div>
                </div>
                
                <div class="flex items-center bg-slate-100 p-1 rounded-lg border border-slate-200 gap-1">
                    <button onclick="setSpeed(1)" class="speed-btn active px-2 py-1 text-[10px] font-black rounded hover:bg-white transition" id="speed-1">1X</button>
                    <button onclick="setSpeed(2)" class="speed-btn px-2 py-1 text-[10px] font-black rounded hover:bg-white transition" id="speed-2">2X</button>
                    <button onclick="setSpeed(5)" class="speed-btn px-2 py-1 text-[10px] font-black rounded hover:bg-white transition" id="speed-5">5X</button>
                    <button onclick="setSpeed(10)" class="speed-btn px-2 py-1 text-[10px] font-black rounded hover:bg-white transition" id="speed-10">10X</button>
                    <button onclick="setSpeed(100)" class="speed-btn px-2 py-1 text-[10px] font-black rounded hover:bg-white transition" id="speed-100">100X</button>
                </div>

                <div class="flex items-center gap-4">
                    <button onclick="location.reload()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-bold transition">Reset</button>
                    <button id="playPauseBtn" onclick="toggleSim()" class="px-8 py-2 bg-slate-900 hover:bg-black text-white rounded-lg text-sm font-bold shadow-lg transition">Start Sim</button>
                </div>
            </div>
        </div>

        <!-- KPI Dashboard -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-xl border border-slate-200">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Raw Materials</p>
                <div id="inv-raw" class="text-2xl font-bold text-slate-800">30</div>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Constraint Stage</p>
                <div id="kpi-bottleneck" class="text-xl font-bold text-red-500 italic">Standby</div>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total WIP</p>
                <div id="kpi-wip" class="text-2xl font-bold text-slate-800">0</div>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Finished Goods</p>
                <div id="inv-fg" class="text-2xl font-bold text-emerald-600">0</div>
            </div>
        </div>

        <!-- Simulation Viewport -->
        <div class="bg-white p-12 rounded-3xl shadow-md border border-slate-200 overflow-x-auto relative">
            <div class="min-w-[1100px] flex items-center justify-between gap-4" id="sim-viewport">
                
                <!-- Inbound Logistics -->
                <div class="relative flex flex-col items-center">
                    <span id="truck-in" class="text-4xl absolute -top-16 opacity-0">ðŸšš</span>
                    <div class="relative w-24 h-40 border-4 border-slate-200 rounded-2xl bg-slate-50 flex flex-wrap content-start p-2 gap-px overflow-hidden" id="vis-raw-inv">
                    </div>
                    <p class="text-[10px] font-bold mt-2 text-slate-400">RAW STORAGE</p>
                </div>

                <!-- Production Stages -->
                <div id="production-line" class="flex items-center gap-6 flex-1 justify-center">
                    <!-- Injected by JavaScript -->
                </div>

                <!-- Outbound Logistics -->
                <div class="relative flex flex-col items-center">
                    <span id="truck-out" class="text-4xl absolute -top-16 opacity-0">ðŸš›</span>
                    <div class="relative w-24 h-40 border-4 border-emerald-100 rounded-2xl bg-emerald-50/30 flex flex-wrap content-start p-2 gap-px overflow-hidden" id="vis-fg-inv">
                    </div>
                    <p class="text-[10px] font-bold mt-2 text-emerald-600">SHIPPING YARD</p>
                </div>
            </div>
        </div>

        <!-- Tuning Panels -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Production Config -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                    Production Line Parameters
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4" id="stage-config-grid"></div>
            </div>

            <!-- Logistics Config -->
            <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-sm flex items-center gap-2">
                        <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path><path d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a2 2 0 002 2h10a2 2 0 002-2v-4M17 9h4l1 3v4a1 1 0 001 1h-1m-4-7V5a1 1 0 00-1-1h-2a1 1 0 01-1-1V2"></path></svg>
                        Supply Chain Settings
                    </h3>
                    <button id="logisticsToggle" onclick="toggleLogistics()" class="toggle-btn toggle-on px-3 py-1 rounded-full text-[10px] font-black uppercase">Limited</button>
                </div>

                <div id="logistics-controls" class="space-y-4">
                    <div class="p-3 bg-white/5 rounded-lg border border-white/10">
                        <p class="text-[9px] font-black text-slate-400 uppercase mb-2">Inbound (Materials)</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[8px] font-bold text-slate-500 mb-1">FREQ (s)</label>
                                <input type="number" id="in-freq" value="15" class="w-full bg-slate-800 text-white border-slate-700 text-xs py-1" onchange="updateLogistics()">
                            </div>
                            <div>
                                <label class="block text-[8px] font-bold text-slate-500 mb-1">QTY</label>
                                <input type="number" id="in-qty" value="10" class="w-full bg-slate-800 text-white border-slate-700 text-xs py-1" onchange="updateLogistics()">
                            </div>
                        </div>
                    </div>

                    <div class="p-3 bg-white/5 rounded-lg border border-white/10">
                        <p class="text-[9px] font-black text-slate-400 uppercase mb-2">Outbound (Shipping)</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[8px] font-bold text-slate-500 mb-1">FREQ (s)</label>
                                <input type="number" id="out-freq" value="25" class="w-full bg-slate-800 text-white border-slate-700 text-xs py-1" onchange="updateLogistics()">
                            </div>
                            <div>
                                <label class="block text-[8px] font-bold text-slate-500 mb-1">CAPACITY</label>
                                <input type="number" id="out-qty" value="20" class="w-full bg-slate-800 text-white border-slate-700 text-xs py-1" onchange="updateLogistics()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const MACHINE_SVG = `<svg class="w-8 h-8 text-slate-200 group-[.processing]:text-emerald-400 transition-colors z-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>`;
        
        let simRunning = false;
        let logisticsUnlimited = false;
        let simSpeed = 1;
        let inventory = { raw: 30, fg: 0, buffers: [0, 0, 0] };
        let stats = { ticks: 0, lastInbound: 0, lastOutbound: 0, seconds: 0 };

        const logisticsConfig = {
            inFreq: 15, inQty: 10,
            outFreq: 25, outQty: 20
        };

        const config = {
            stages: [
                { name: 'Flour Mixing', machines: 1, time: 3, batchSize: 1, type: 'icon', icon: 'âšª', load: 0, utilSum: 0, ticks: 0 },
                { name: 'Reducer/Cutting', machines: 2, time: 6, batchSize: 1, type: 'noodle', load: 0, utilSum: 0, ticks: 0 },
                { name: 'Boiling/Cooling', machines: 1, time: 5, batchSize: 2, type: 'noodle', load: 0, utilSum: 0, ticks: 0 },
                { name: 'Final Packing', machines: 1, time: 2, batchSize: 4, type: 'icon', icon: 'ðŸ“¦', load: 0, utilSum: 0, ticks: 0 }
            ]
        };

        function init() {
            renderProductionLine();
            renderControls();
            updateLogistics();
            updateUI(); // Initial UI draw
        }

        function setSpeed(val) {
            simSpeed = val;
            document.querySelectorAll('.speed-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`speed-${val}`).classList.add('active');
            updateLogistics();
        }

        function updateClock() {
            const h = Math.floor(stats.seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((stats.seconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(stats.seconds % 60).toString().padStart(2, '0');
            document.getElementById('sim-clock').innerText = `${h}:${m}:${s}`;
        }

        function toggleLogistics() {
            logisticsUnlimited = !logisticsUnlimited;
            const btn = document.getElementById('logisticsToggle');
            const ctrls = document.getElementById('logistics-controls');
            const truckIn = document.getElementById('truck-in');
            const truckOut = document.getElementById('truck-out');
            
            if (logisticsUnlimited) {
                btn.innerText = "Unlimited";
                btn.className = "toggle-btn toggle-off px-3 py-1 rounded-full text-[10px] font-black uppercase";
                ctrls.classList.add('opacity-30', 'pointer-events-none');
                truckIn.className = "text-4xl absolute -top-16 opacity-0";
                truckOut.className = "text-4xl absolute -top-16 opacity-0";
                inventory.raw = 99;
            } else {
                btn.innerText = "Limited";
                btn.className = "toggle-btn toggle-on px-3 py-1 rounded-full text-[10px] font-black uppercase";
                ctrls.classList.remove('opacity-30', 'pointer-events-none');
            }
            updateUI();
        }

        function updateLogistics() {
            logisticsConfig.inFreq = parseInt(document.getElementById('in-freq').value) || 1;
            logisticsConfig.inQty = parseInt(document.getElementById('in-qty').value) || 1;
            logisticsConfig.outFreq = parseInt(document.getElementById('out-freq').value) || 1;
            logisticsConfig.outQty = parseInt(document.getElementById('out-qty').value) || 1;
            
            document.documentElement.style.setProperty('--in-dur', (logisticsConfig.inFreq / simSpeed) + 's');
            document.documentElement.style.setProperty('--out-dur', (logisticsConfig.outFreq / simSpeed) + 's');
        }

        function renderProductionLine() {
            const container = document.getElementById('production-line');
            container.innerHTML = '';
            config.stages.forEach((s, idx) => {
                const sDiv = document.createElement('div');
                sDiv.id = `stage-node-${idx}`;
                sDiv.className = "flex flex-col items-center p-4 rounded-3xl border-2 border-slate-100 bg-white w-40 shadow-sm transition-all";
                let mHtml = '';
                for(let i=0; i<s.machines; i++) {
                    const unitHtml = s.type === 'noodle' ? `<div class="unit unit-entering noodle-strand"></div>` : `<div class="unit unit-entering text-xl">${s.icon}</div>`;
                    mHtml += `<div id="m-${idx}-${i}" class="group machine-node w-14 h-14 rounded-xl bg-slate-50 border border-slate-200">${MACHINE_SVG}${unitHtml}</div>`;
                }
                sDiv.innerHTML = `<span class="text-[10px] font-black text-slate-400 uppercase mb-3 text-center h-8 flex items-center">${s.name}</span>
                    <div class="grid grid-cols-1 gap-2 justify-items-center w-full">${mHtml}</div>
                    <div class="mt-3 text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full" id="util-text-${idx}">0%</div>`;
                container.appendChild(sDiv);
                if (idx < config.stages.length - 1) {
                    const bDiv = document.createElement('div');
                    bDiv.innerHTML = `<div id="buf-vis-${idx}" class="w-8 min-h-[60px] bg-slate-100/50 border border-dashed border-slate-200 rounded-lg flex flex-wrap p-1 content-start gap-px"></div>`;
                    container.appendChild(bDiv);
                }
            });
        }

        function renderControls() {
            const grid = document.getElementById('stage-config-grid');
            grid.innerHTML = '';
            config.stages.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = "bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3";
                div.innerHTML = `<p class="text-[10px] font-black text-slate-800 uppercase">${s.name}</p>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center"><label class="text-[9px] text-slate-500 font-bold uppercase">Machines</label><input type="number" value="${s.machines}" onchange="updateStage(${i}, 'machines', this.value)"></div>
                        <div class="flex justify-between items-center"><label class="text-[9px] text-slate-500 font-bold uppercase">Time (s)</label><input type="number" value="${s.time}" onchange="updateStage(${i}, 'time', this.value)"></div>
                        <div class="flex justify-between items-center"><label class="text-[9px] text-amber-600 font-bold uppercase">Batch</label><input type="number" value="${s.batchSize}" onchange="updateStage(${i}, 'batchSize', this.value)"></div>
                    </div>`;
                grid.appendChild(div);
            });
        }

        function updateStage(idx, key, val) {
            config.stages[idx][key] = parseInt(val);
            renderProductionLine();
        }

        function simulationStep() {
            if (!simRunning) return;

            const secondsPerStep = 0.5 * simSpeed;
            stats.seconds += secondsPerStep;
            updateClock();

            if (!logisticsUnlimited) {
                const truckIn = document.getElementById('truck-in');
                const truckOut = document.getElementById('truck-out');
                
                if (!truckIn.classList.contains('anim-inbound')) truckIn.className = "text-4xl absolute -top-16 anim-inbound";
                if (!truckOut.classList.contains('anim-outbound')) truckOut.className = "text-4xl absolute -top-16 anim-outbound";

                if (Math.floor(stats.seconds / logisticsConfig.inFreq) > Math.floor((stats.seconds - secondsPerStep) / logisticsConfig.inFreq)) {
                    inventory.raw += logisticsConfig.inQty;
                }
                if (Math.floor(stats.seconds / logisticsConfig.outFreq) > Math.floor((stats.seconds - secondsPerStep) / logisticsConfig.outFreq)) {
                    inventory.fg = Math.max(0, inventory.fg - logisticsConfig.outQty);
                }
            } else {
                inventory.raw = 99;
                inventory.fg = 0;
            }

            config.stages.forEach((stage, idx) => {
                let canProcess = false;
                if (logisticsUnlimited && idx === 0) {
                    canProcess = true; 
                } else {
                    let availableInput = (idx === 0) ? inventory.raw : inventory.buffers[idx-1];
                    canProcess = availableInput >= stage.batchSize;
                }

                if (stage.load < stage.machines && canProcess) {
                    if (!logisticsUnlimited || idx !== 0) {
                        if (idx === 0) inventory.raw -= stage.batchSize;
                        else inventory.buffers[idx-1] -= stage.batchSize;
                    }
                    startBatch(idx);
                }
                stage.utilSum += (stage.load / stage.machines);
                stage.ticks++;
            });

            stats.ticks++;
            updateUI();
            setTimeout(simulationStep, 500 / (simSpeed === 100 ? 10 : 1));
        }

        async function startBatch(stageIdx) {
            const stage = config.stages[stageIdx];
            stage.load++;
            
            const machines = document.querySelectorAll(`#stage-node-${stageIdx} .machine-node`);
            let machineEl = null;
            for(let el of machines) {
                if (!el.classList.contains('processing')) { machineEl = el; break; }
            }

            if (machineEl) {
                const unitIcon = machineEl.querySelector('.unit');
                machineEl.classList.add('processing');
                unitIcon.className = stage.type === 'noodle' ? 'unit unit-processing noodle-strand' : 'unit unit-processing text-xl';
                
                await new Promise(r => setTimeout(r, (stage.time * 1000) / simSpeed));

                unitIcon.className = stage.type === 'noodle' ? 'unit unit-exiting noodle-strand' : 'unit unit-exiting text-xl';
                machineEl.classList.remove('processing');
                
                setTimeout(() => {
                    unitIcon.className = stage.type === 'noodle' ? 'unit unit-entering noodle-strand' : 'unit unit-entering text-xl';
                }, 500 / simSpeed);
            }

            stage.load--;
            if (stageIdx === config.stages.length - 1) {
                if (!logisticsUnlimited) inventory.fg += stage.batchSize;
            } else {
                inventory.buffers[stageIdx] += stage.batchSize;
            }
        }

        function updateUI() {
            document.getElementById('inv-raw').innerText = logisticsUnlimited ? 'âˆž' : inventory.raw;
            document.getElementById('inv-fg').innerText = logisticsUnlimited ? 'âˆž' : inventory.fg;
            document.getElementById('kpi-wip').innerText = config.stages.reduce((a,b) => a + b.load, 0) + inventory.buffers.reduce((a,b) => a+b, 0);
            
            const drawItems = (id, count, color, unlimitedMsg = '') => {
                const el = document.getElementById(id);
                if (!el) return;
                
                let html = '';
                if (logisticsUnlimited && unlimitedMsg) {
                    html = `<div class="absolute inset-0 flex items-center justify-center bg-slate-100/80">
                                <span class="text-slate-400 font-black text-[10px] rotate-45 text-center">${unlimitedMsg}</span>
                            </div>`;
                } else {
                    const limit = 45;
                    for(let i=0; i<Math.min(count, limit); i++) html += `<div class="buffer-pill" style="background:${color}"></div>`;
                }
                el.innerHTML = html;
            };

            drawItems('vis-raw-inv', inventory.raw, '#94a3b8', 'UNLIMITED');
            drawItems('vis-fg-inv', inventory.fg, '#10b981', 'AUTO SHIP');
            inventory.buffers.forEach((val, i) => drawItems(`buf-vis-${i}`, val, '#cbd5e1'));

            let maxU = -1;
            let bnIdx = -1;
            config.stages.forEach((s, i) => {
                const u = (s.utilSum / s.ticks) * 100;
                const utilEl = document.getElementById(`util-text-${i}`);
                if (utilEl) utilEl.innerText = isNaN(u) ? '0%' : u.toFixed(0) + '%';
                
                const node = document.getElementById(`stage-node-${i}`);
                if (node) {
                    node.classList.remove('bottleneck-glow');
                    if (u > maxU) { maxU = u; bnIdx = i; }
                }
            });

            if (bnIdx !== -1 && maxU > 2) {
                document.getElementById('kpi-bottleneck').innerText = config.stages[bnIdx].name;
                const bnNode = document.getElementById(`stage-node-${bnIdx}`);
                if (bnNode) bnNode.classList.add('bottleneck-glow');
            }
        }

        function toggleSim() {
            simRunning = !simRunning;
            const btn = document.getElementById('playPauseBtn');
            btn.innerText = simRunning ? "Stop Sim" : "Resume Sim";
            if (simRunning) simulationStep();
        }

        init();
    </script>
</body>
</html>
